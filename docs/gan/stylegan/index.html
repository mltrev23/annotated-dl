<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="An annotated PyTorch implementation of StyleGAN2."/>

    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:image:src" content="https://avatars1.githubusercontent.com/u/64068543?s=400&amp;v=4"/>
    <meta name="twitter:title" content="Style GAN 2"/>
    <meta name="twitter:description" content="An annotated PyTorch implementation of StyleGAN2."/>
    <meta name="twitter:site" content="@labmlai"/>
    <meta name="twitter:creator" content="@labmlai"/>

    <meta property="og:url" content="https://nn.labml.ai/gan/stylegan/index.html"/>
    <meta property="og:title" content="Style GAN 2"/>
    <meta property="og:image" content="https://avatars1.githubusercontent.com/u/64068543?s=400&amp;v=4"/>
    <meta property="og:site_name" content="LabML Neural Networks"/>
    <meta property="og:type" content="object"/>
    <meta property="og:title" content="Style GAN 2"/>
    <meta property="og:description" content="An annotated PyTorch implementation of StyleGAN2."/>

    <title>Style GAN 2</title>
    <link rel="shortcut icon" href="/icon.png"/>
    <link rel="stylesheet" href="../../pylit.css">
    <link rel="canonical" href="https://nn.labml.ai/gan/stylegan/index.html"/>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4V3HC8HBLH"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-4V3HC8HBLH');
    </script>
</head>
<body>
<div id='container'>
    <div id="background"></div>
    <div class='section'>
        <div class='docs'>
            <p>
                <a class="parent" href="/">home</a>
                <a class="parent" href="../index.html">gan</a>
                <a class="parent" href="index.html">stylegan</a>
            </p>
            <p>

                <a href="https://github.com/lab-ml/labml_nn/tree/master/labml_nn/gan/stylegan/__init__.py">
                    <img alt="Github"
                         src="https://img.shields.io/github/stars/lab-ml/nn?style=social"
                         style="max-width:100%;"/></a>
                <a href="https://twitter.com/labmlai"
                   rel="nofollow">
                    <img alt="Twitter"
                         src="https://img.shields.io/twitter/follow/labmlai?style=social"
                         style="max-width:100%;"/></a>
            </p>
        </div>
    </div>
    <div class='section' id='section-0'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-0'>#</a>
                </div>
                <h1>Style GAN 2</h1>
<p>This is a <a href="https://pytorch.org">PyTorch</a> implementation of the paper
 <a href="https://arxiv.org/abs/1912.04958">Analyzing and Improving the Image Quality of StyleGAN</a>
 which introduces <strong>Style GAN2</strong>.
Style GAN2 is an improvement over <strong>Style GAN</strong> from the paper
 <a href="https://arxiv.org/abs/1812.04948">A Style-Based Generator Architecture for Generative Adversarial Networks</a>.
And Style GAN is based on <strong>Progressive GAN</strong> from the paper
 <a href="https://arxiv.org/abs/1710.10196">Progressive Growing of GANs for Improved Quality, Stability, and Variation</a>.
All three papers are from the same authors from <a href="https://twitter.com/NVIDIAAI">NVIDIA AI</a>.</p>
<p><em>Our implementation is a minimalistic Style GAN2 model training code.
Only single GPU training is supported to keep the implementation simple.
We managed to shrink it to keep it at less than 500 lines of code, including the training loop.</em></p>
<p><strong>üèÉ Here&rsquo;s the training code: <a href="experiment.html"><code>experiment.py</code></a>.</strong></p>
<p><img alt="Generated Images" src="generated_64.png" /></p>
<p><em><small>These are $64 \times 64$ images generated after training for about 80K steps.</small></em></p>
<p>We&rsquo;ll first introduce the three papers at a high level.</p>
<h2>Generative Adversarial Networks</h2>
<p>Generative adversarial networks have two components; the generator and the discriminator.
The generator network takes a random latent vector ($z \in \mathcal{Z}$)
 and tries to generate a realistic image.
The discriminator network tries to differentiate the real images from generated images.
When we train the two networks together the generator starts generating images indistinguishable from real images.</p>
<h2>Progressive GAN</h2>
<p>Progressive GAN generates high-resolution images ($1080 \times 1080$) of size.
It does so by <em>progressively</em> increasing the image size.
First, it trains a network that produces a $4 \times 4$ image, then $8 \times 8$ ,
 then an $16 \times 16$  image, and so on up to the desired image resolution.</p>
<p>At each resolution, the generator network produces an image in latent space which is converted into RGB,
with a $1 \times 1$  convolution.
When we progress from a lower resolution to a higher resolution
 (say from $4 \times 4$  to $8 \times 8$ ) we scale the latent image by $2\times$
 and add a new block (two $3 \times 3$  convolution layers)
 and a new $1 \times 1$  layer to get RGB.
The transition is done smoothly by adding a residual connection to
 the $2\times$ scaled $4 \times 4$  RGB image.
The weight of this residual connection is slowly reduced, to let the new block take over.</p>
<p>The discriminator is a mirror image of the generator network.
The progressive growth of the discriminator is done similarly.</p>
<p><img alt="progressive_gan.svg" src="progressive_gan.svg" /></p>
<p><em><small>$2\times$ and $0.5\times$ denote feature map resolution scaling and scaling.
$4\times4$, $8\times4$, &hellip; denote feature map resolution at the generator or discriminator block.
Each discriminator and generator block consists of 2 convolution layers with leaky ReLU activations.</small></em></p>
<p>They use <strong>minibatch standard deviation</strong> to increase variation and
 <strong>equalized learning rate</strong> which we discussed below in the implementation.
They also use <strong>pixel-wise normalization</strong> where at each pixel the feature vector is normalized.
They apply this to all the convolution layer outputs (except RGB).</p>
<h2>Style GAN</h2>
<p>Style GAN improves the generator of Progressive GAN keeping the discriminator architecture the same.</p>
<h4>Mapping Network</h4>
<p>It maps the random latent vector ($z \in \mathcal{Z}$)
 into a different latent space ($w \in \mathcal{W}$),
 with an 8-layer neural network.
This gives an intermediate latent space $\mathcal{W}$
where the factors of variations are more linear (disentangled).</p>
<h4>AdaIN</h4>
<p>Then $w$ is transformed into two vectors (<strong><em>styles</em></strong>) per layer,
 $i$, $y_i = (y_{s,i}, y_{b,i}) = f_{A_i}(w)$ and used for scaling and shifting (biasing)
 in each layer with $\text{AdaIN}$ operator (normalize and scale):
<script type="math/tex; mode=display">\text{AdaIN}(x_i, y_i) = y_{s, i} \frac{x_i - \mu(x_i)}{\sigma(x_i)} + y_{b,i}</script>
</p>
<h4>Style Mixing</h4>
<p>To prevent the generator from assuming adjacent styles are correlated,
 they randomly use different styles for different blocks.
That is, they sample two latent vectors $(z_1, z_2)$ and corresponding $(w_1, w_2)$ and
 use $w_1$ based styles for some blocks and $w_2$ based styles for some blacks randomly.</p>
<h4>Stochastic Variation</h4>
<p>Noise is made available to each block which helps the generator create more realistic images.
Noise is scaled per channel by a learned weight.</p>
<h4>Bilinear Up and Down Sampling</h4>
<p>All the up and down-sampling operations are accompanied by bilinear smoothing.</p>
<p><img alt="style_gan.svg" src="style_gan.svg" /></p>
<p><em><small>$A$ denotes a linear layer.
$B$ denotes a broadcast and scaling operation (noise is a single channel).
Style GAN also uses progressive growing like Progressive GAN</small></em></p>
<h2>Style GAN 2</h2>
<p>Style GAN 2 changes both the generator and the discriminator of Style GAN.</p>
<h4>Weight Modulation and Demodulation</h4>
<p>They remove the $\text{AdaIN}$ operator and replace it with
 the weight modulation and demodulation step.
This is supposed to improve what they call droplet artifacts that are present in generated images,
 which are caused by the normalization in $\text{AdaIN}$ operator.
Style vector per layer is calculated from $w_i \in \mathcal{W}$ as $s_i = f_{A_i}(w_i)$.</p>
<p>Then the convolution weights $w$ are modulated as follows.
($w$ here on refers to weights not intermediate latent space,
 we are sticking to the same notation as the paper.)</p>
<p>
<script type="math/tex; mode=display">w'_{i, j, k} = s_i \cdot w_{i, j, k}</script>
Then it&rsquo;s demodulated by normalizing,
<script type="math/tex; mode=display">w''_{i,j,k} = \frac{w'_{i,j,k}}{\sqrt{\sum_{i,k}{w'_{i, j, k}}^2 + \epsilon}}</script>
where $i$ is the input channel, $j$ is the output channel, and $k$ is the kernel index.</p>
<h4>Path Length Regularization</h4>
<p>Path length regularization encourages a fixed-size step in $\mathcal{W}$ to result in a non-zero,
 fixed-magnitude change in the generated image.</p>
<h4>No Progressive Growing</h4>
<p>StyleGAN2 uses residual connections (with down-sampling) in the discriminator and skip connections
 in the generator with up-sampling
  (the RGB outputs from each layer are added - no residual connections in feature maps).
They show that with experiments that the contribution of low-resolution layers is higher
 at beginning of the training and then high-resolution layers take over.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">148</span><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="lineno">149</span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="lineno">150</span>
<span class="lineno">151</span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="lineno">152</span><span class="kn">import</span> <span class="nn">torch</span>
<span class="lineno">153</span><span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="lineno">154</span><span class="kn">import</span> <span class="nn">torch.utils.data</span>
<span class="lineno">155</span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-1'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-1'>#</a>
                </div>
                <p><a id="mapping_network"></a></p>
<h2>Mapping Network</h2>
<p><img alt="Mapping Network" src="mapping_network.svg" /></p>
<p>This is an MLP with 8 linear layers.
The mapping network maps the latent vector $z \in \mathcal{W}$
to an intermediate latent space $w \in \mathcal{W}$.
$\mathcal{W}$ space will be disentangled from the image space
where the factors of variation become more linear.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">158</span><span class="k">class</span> <span class="nc">MappingNetwork</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-2'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-2'>#</a>
                </div>
                <ul>
<li><code>features</code> is the number of features in $z$ and $w$</li>
<li><code>n_layers</code> is the number of layers in the mapping network.</li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">172</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-3'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-3'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">177</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-4'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-4'>#</a>
                </div>
                <p>Create the MLP</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">180</span>        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">181</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_layers</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-5'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-5'>#</a>
                </div>
                <p><a href="#equalized_linear">Equalized learning-rate linear layers</a></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">183</span>            <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EqualizedLinear</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">features</span><span class="p">))</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-6'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-6'>#</a>
                </div>
                <p>Leaky Relu</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">185</span>            <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="n">negative_slope</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="lineno">186</span>
<span class="lineno">187</span>        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-7'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-7'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">189</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-8'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-8'>#</a>
                </div>
                <p>Normalize $z$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">191</span>        <span class="n">z</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-9'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-9'>#</a>
                </div>
                <p>Map $z$ to $w$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">193</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">z</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-10'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-10'>#</a>
                </div>
                <p><a id="generator"></a></p>
<h2>StyleGAN2 Generator</h2>
<p><img alt="Generator" src="style_gan2.svg" /></p>
<p><em><small>$A$ denotes a linear layer.
$B$ denotes a broadcast and scaling operation (noise is a single channel).
<a href="#to_rgb"><em>toRGB</em></a> also has a style modulation which is not shown in the diagram to keep it simple.</small></em></p>
<p>The generator starts with a learned constant.
Then it has a series of blocks. The feature map resolution is doubled at each block
Each block outputs an RGB image and they are scaled up and summed to get the final RGB image.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">196</span><span class="k">class</span> <span class="nc">Generator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-11'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-11'>#</a>
                </div>
                <ul>
<li><code>log_resolution</code> is the $\log_2$ of image resolution</li>
<li><code>d_latent</code> is the dimensionality of $w$</li>
<li><code>n_features</code> number of features in the convolution layer at the highest resolution (final block)</li>
<li><code>max_features</code> maximum number of features in any generator block</li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">212</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_resolution</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">d_latent</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_features</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="n">max_features</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-12'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-12'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">219</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-13'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-13'>#</a>
                </div>
                <p>Calculate the number of features for each block</p>
<p>Something like <code>[512, 512, 256, 128, 64, 32]</code></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">224</span>        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">max_features</span><span class="p">,</span> <span class="n">n_features</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">log_resolution</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-14'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-14'>#</a>
                </div>
                <p>Number of generator blocks</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">226</span>        <span class="bp">self</span><span class="o">.</span><span class="n">n_blocks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-15'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-15'>#</a>
                </div>
                <p>Trainable $4 \times 4$ constant</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">229</span>        <span class="bp">self</span><span class="o">.</span><span class="n">initial_constant</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-16'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-16'>#</a>
                </div>
                <p>First style block for $4 \times 4$ resolution and layer to get RGB</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">232</span>        <span class="bp">self</span><span class="o">.</span><span class="n">style_block</span> <span class="o">=</span> <span class="n">StyleBlock</span><span class="p">(</span><span class="n">d_latent</span><span class="p">,</span> <span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="lineno">233</span>        <span class="bp">self</span><span class="o">.</span><span class="n">to_rgb</span> <span class="o">=</span> <span class="n">ToRGB</span><span class="p">(</span><span class="n">d_latent</span><span class="p">,</span> <span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-17'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-17'>#</a>
                </div>
                <p>Generator blocks</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">236</span>        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">GeneratorBlock</span><span class="p">(</span><span class="n">d_latent</span><span class="p">,</span> <span class="n">features</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_blocks</span><span class="p">)]</span>
<span class="lineno">237</span>        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-18'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-18'>#</a>
                </div>
                <p>$2 \times$ up sampling layer. The feature space is up sampled
at each block</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">241</span>        <span class="bp">self</span><span class="o">.</span><span class="n">up_sample</span> <span class="o">=</span> <span class="n">UpSample</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-19'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-19'>#</a>
                </div>
                <ul>
<li><code>w</code> is $w$. In order to mix-styles (use different $w$ for different layers), we provide a separate
$w$ for each <a href="#generator_block">generator block</a>. It has shape `[n_blocks, batch_size, d_latent]1.</li>
<li><code>input_noise</code> is the noise for each block.
It&rsquo;s a list of pairs of noise sensors because each block (except the initial) has two noise inputs
after each convolution layer (see the diagram).</li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">243</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">input_noise</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-20'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-20'>#</a>
                </div>
                <p>Get batch size</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">253</span>        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-21'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-21'>#</a>
                </div>
                <p>Expand the learned constant to match batch size</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">256</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_constant</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-22'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-22'>#</a>
                </div>
                <p>The first style block</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">259</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">input_noise</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-23'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-23'>#</a>
                </div>
                <p>Get first rgb image</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">261</span>        <span class="n">rgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_rgb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-24'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-24'>#</a>
                </div>
                <p>Evaluate rest of the blocks</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">264</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_blocks</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-25'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-25'>#</a>
                </div>
                <p>Up sample the feature map</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">266</span>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up_sample</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-26'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-26'>#</a>
                </div>
                <p>Run it through the <a href="#generator_block">generator block</a></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">268</span>            <span class="n">x</span><span class="p">,</span> <span class="n">rgb_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">](</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">input_noise</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-27'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-27'>#</a>
                </div>
                <p>Up sample the RGB image and add to the rgb from the block</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">270</span>            <span class="n">rgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up_sample</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span> <span class="o">+</span> <span class="n">rgb_new</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-28'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-28'>#</a>
                </div>
                <p>Return the final RGB image</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">273</span>        <span class="k">return</span> <span class="n">rgb</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-29'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-29'>#</a>
                </div>
                <p><a id="generator_block"></a></p>
<h3>Generator Block</h3>
<p><img alt="Generator block" src="generator_block.svg" /></p>
<p><em><small>$A$ denotes a linear layer.
$B$ denotes a broadcast and scaling operation (noise is a single channel).
<a href="#to_rgb"><em>toRGB</em></a> also has a style modulation which is not shown in the diagram to keep it simple.</small></em></p>
<p>The generator block consists of two <a href="#style_block">style blocks</a> ($3 \times 3$ convolutions with style modulation)
and an RGB output.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">276</span><span class="k">class</span> <span class="nc">GeneratorBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-30'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-30'>#</a>
                </div>
                <ul>
<li><code>d_latent</code> is the dimensionality of $w$</li>
<li><code>in_features</code> is the number of features in the input feature map</li>
<li><code>out_features</code> is the number of features in the output feature map</li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">291</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_latent</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">in_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">out_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-31'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-31'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">297</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-32'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-32'>#</a>
                </div>
                <p>First <a href="#style_block">style block</a> changes the feature map size to <code>out_features</code></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">300</span>        <span class="bp">self</span><span class="o">.</span><span class="n">style_block1</span> <span class="o">=</span> <span class="n">StyleBlock</span><span class="p">(</span><span class="n">d_latent</span><span class="p">,</span> <span class="n">in_features</span><span class="p">,</span> <span class="n">out_features</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-33'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-33'>#</a>
                </div>
                <p>Second <a href="#style_block">style block</a></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">302</span>        <span class="bp">self</span><span class="o">.</span><span class="n">style_block2</span> <span class="o">=</span> <span class="n">StyleBlock</span><span class="p">(</span><span class="n">d_latent</span><span class="p">,</span> <span class="n">out_features</span><span class="p">,</span> <span class="n">out_features</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-34'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-34'>#</a>
                </div>
                <p><em>toRGB</em> layer</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">305</span>        <span class="bp">self</span><span class="o">.</span><span class="n">to_rgb</span> <span class="o">=</span> <span class="n">ToRGB</span><span class="p">(</span><span class="n">d_latent</span><span class="p">,</span> <span class="n">out_features</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-35'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-35'>#</a>
                </div>
                <ul>
<li><code>x</code> is the input feature map of shape <code>[batch_size, in_features, height, width]</code></li>
<li><code>w</code> is $w$ with shape <code>[batch_size, d_latent]</code></li>
<li><code>noise</code> is a tuple of two noise tensors of shape <code>[batch_size, 1, height, width]</code></li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">307</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">noise</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-36'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-36'>#</a>
                </div>
                <p>First style block with first noise tensor.
The output is of shape <code>[batch_size, out_features, height, width]</code></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">315</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style_block1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">noise</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-37'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-37'>#</a>
                </div>
                <p>Second style block with second noise tensor.
The output is of shape <code>[batch_size, out_features, height, width]</code></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">318</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style_block2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">noise</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-38'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-38'>#</a>
                </div>
                <p>Get RGB image</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">321</span>        <span class="n">rgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_rgb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-39'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-39'>#</a>
                </div>
                <p>Return feature map and rgb image</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">324</span>        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">rgb</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-40'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-40'>#</a>
                </div>
                <p><a id="style_block"></a></p>
<h3>Style Block</h3>
<p><img alt="Style block" src="style_block.svg" /></p>
<p><em><small>$A$ denotes a linear layer.
$B$ denotes a broadcast and scaling operation (noise is single channel).</small></em></p>
<p>Style block has a weight modulation convolution layer.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">327</span><span class="k">class</span> <span class="nc">StyleBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-41'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-41'>#</a>
                </div>
                <ul>
<li><code>d_latent</code> is the dimensionality of $w$</li>
<li><code>in_features</code> is the number of features in the input feature map</li>
<li><code>out_features</code> is the number of features in the output feature map</li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">340</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_latent</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">in_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">out_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-42'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-42'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">346</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-43'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-43'>#</a>
                </div>
                <p>Get style vector from $w$ (denoted by $A$ in the diagram) with
an <a href="#equalized_linear">equalized learning-rate linear layer</a></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">349</span>        <span class="bp">self</span><span class="o">.</span><span class="n">to_style</span> <span class="o">=</span> <span class="n">EqualizedLinear</span><span class="p">(</span><span class="n">d_latent</span><span class="p">,</span> <span class="n">in_features</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-44'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-44'>#</a>
                </div>
                <p>Weight modulated convolution layer</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">351</span>        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">Conv2dWeightModulate</span><span class="p">(</span><span class="n">in_features</span><span class="p">,</span> <span class="n">out_features</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-45'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-45'>#</a>
                </div>
                <p>Noise scale</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">353</span>        <span class="bp">self</span><span class="o">.</span><span class="n">scale_noise</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-46'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-46'>#</a>
                </div>
                <p>Bias</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">355</span>        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">out_features</span><span class="p">))</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-47'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-47'>#</a>
                </div>
                <p>Activation function</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">358</span>        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-48'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-48'>#</a>
                </div>
                <ul>
<li><code>x</code> is the input feature map of shape <code>[batch_size, in_features, height, width]</code></li>
<li><code>w</code> is $w$ with shape <code>[batch_size, d_latent]</code></li>
<li><code>noise</code> is a tensor of shape <code>[batch_size, 1, height, width]</code></li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">360</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">noise</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-49'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-49'>#</a>
                </div>
                <p>Get style vector $s$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">367</span>        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_style</span><span class="p">(</span><span class="n">w</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-50'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-50'>#</a>
                </div>
                <p>Weight modulated convolution</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">369</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-51'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-51'>#</a>
                </div>
                <p>Scale and add noise</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">371</span>        <span class="k">if</span> <span class="n">noise</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="lineno">372</span>            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_noise</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">noise</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-52'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-52'>#</a>
                </div>
                <p>Add bias and evaluate activation function</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">374</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-53'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-53'>#</a>
                </div>
                <p><a id="to_rgb"></a></p>
<h3>To RGB</h3>
<p><img alt="To RGB" src="to_rgb.svg" /></p>
<p><em><small>$A$ denotes a linear layer.</small></em></p>
<p>Generates an RGB image from a feature map using $1 \times 1$ convolution.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">377</span><span class="k">class</span> <span class="nc">ToRGB</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-54'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-54'>#</a>
                </div>
                <ul>
<li><code>d_latent</code> is the dimensionality of $w$</li>
<li><code>features</code> is the number of features in the feature map</li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">389</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_latent</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-55'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-55'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">394</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-56'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-56'>#</a>
                </div>
                <p>Get style vector from $w$ (denoted by $A$ in the diagram) with
an <a href="#equalized_linear">equalized learning-rate linear layer</a></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">397</span>        <span class="bp">self</span><span class="o">.</span><span class="n">to_style</span> <span class="o">=</span> <span class="n">EqualizedLinear</span><span class="p">(</span><span class="n">d_latent</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-57'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-57'>#</a>
                </div>
                <p>Weight modulated convolution layer without demodulation</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">400</span>        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">Conv2dWeightModulate</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">demodulate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-58'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-58'>#</a>
                </div>
                <p>Bias</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">402</span>        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-59'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-59'>#</a>
                </div>
                <p>Activation function</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">404</span>        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-60'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-60'>#</a>
                </div>
                <ul>
<li><code>x</code> is the input feature map of shape <code>[batch_size, in_features, height, width]</code></li>
<li><code>w</code> is $w$ with shape <code>[batch_size, d_latent]</code></li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">406</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-61'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-61'>#</a>
                </div>
                <p>Get style vector $s$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">412</span>        <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_style</span><span class="p">(</span><span class="n">w</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-62'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-62'>#</a>
                </div>
                <p>Weight modulated convolution</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">414</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-63'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-63'>#</a>
                </div>
                <p>Add bias and evaluate activation function</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">416</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-64'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-64'>#</a>
                </div>
                <h3>Convolution with Weight Modulation and Demodulation</h3>
<p>This layer scales the convolution weights by the style vector and demodulates by normalizing it.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">419</span><span class="k">class</span> <span class="nc">Conv2dWeightModulate</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-65'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-65'>#</a>
                </div>
                <ul>
<li><code>in_features</code> is the number of features in the input feature map</li>
<li><code>out_features</code> is the number of features in the output feature map</li>
<li><code>kernel_size</code> is the size of the convolution kernel</li>
<li><code>demodulate</code> is flag whether to normalize weights by its standard deviation</li>
<li><code>eps</code> is the $\epsilon$ for normalizing</li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">426</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">out_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="lineno">427</span>                 <span class="n">demodulate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-8</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-66'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-66'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">435</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-67'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-67'>#</a>
                </div>
                <p>Number of output features</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">437</span>        <span class="bp">self</span><span class="o">.</span><span class="n">out_features</span> <span class="o">=</span> <span class="n">out_features</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-68'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-68'>#</a>
                </div>
                <p>Whether to normalize weights</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">439</span>        <span class="bp">self</span><span class="o">.</span><span class="n">demodulate</span> <span class="o">=</span> <span class="n">demodulate</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-69'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-69'>#</a>
                </div>
                <p>Padding size</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">441</span>        <span class="bp">self</span><span class="o">.</span><span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernel_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-70'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-70'>#</a>
                </div>
                <p><a href="#equalized_weight">Weights parameter with equalized learning rate</a></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">444</span>        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">EqualizedWeight</span><span class="p">([</span><span class="n">out_features</span><span class="p">,</span> <span class="n">in_features</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">])</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-71'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-71'>#</a>
                </div>
                <p>$\epsilon$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">446</span>        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-72'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-72'>#</a>
                </div>
                <ul>
<li><code>x</code> is the input feature map of shape <code>[batch_size, in_features, height, width]</code></li>
<li><code>s</code> is style based scaling tensor of shape <code>[batch_size, in_features]</code></li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">448</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-73'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-73'>#</a>
                </div>
                <p>Get batch size, height and width</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">455</span>        <span class="n">b</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-74'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-74'>#</a>
                </div>
                <p>Reshape the scales</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">458</span>        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-75'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-75'>#</a>
                </div>
                <p>Get <a href="#equalized_weight">learning rate equalized weights</a></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">460</span>        <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">()[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-76'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-76'>#</a>
                </div>
                <p>
<script type="math/tex; mode=display">w`_{i,j,k} = s_i * w_{i,j,k}</script>
where $i$ is the input channel, $j$ is the output channel, and $k$ is the kernel index.</p>
<p>The result has shape <code>[batch_size, out_features, in_features, kernel_size, kernel_size]</code></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">465</span>        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">s</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-77'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-77'>#</a>
                </div>
                <p>Demodulate</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">468</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">demodulate</span><span class="p">:</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-78'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-78'>#</a>
                </div>
                <p>
<script type="math/tex; mode=display">\sigma_j = \sqrt{\sum_{i,k} (w'_{i, j, k})^2 + \epsilon}</script>
</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">470</span>            <span class="n">sigma_inv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rsqrt</span><span class="p">((</span><span class="n">weights</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-79'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-79'>#</a>
                </div>
                <p>
<script type="math/tex; mode=display">w''_{i,j,k} = \frac{w'_{i,j,k}}{\sqrt{\sum_{i,k} (w'_{i, j, k})^2 + \epsilon}}</script>
</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">472</span>            <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">sigma_inv</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-80'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-80'>#</a>
                </div>
                <p>Reshape <code>x</code></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">475</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-81'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-81'>#</a>
                </div>
                <p>Reshape weights</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">478</span>        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="o">*</span><span class="n">ws</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape</span>
<span class="lineno">479</span>        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_features</span><span class="p">,</span> <span class="o">*</span><span class="n">ws</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-82'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-82'>#</a>
                </div>
                <p>Use grouped convolution to efficiently calculate the convolution with sample wise kernel.
i.e. we have a different kernel (weights) for each sample in the batch</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">483</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">b</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-83'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-83'>#</a>
                </div>
                <p>Reshape <code>x</code> to <code>[batch_size, out_features, height, width]</code> and return</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">486</span>        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_features</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-84'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-84'>#</a>
                </div>
                <p><a id="discriminator"></a></p>
<h2>Style GAN2 Discriminator</h2>
<p><img alt="Discriminator" src="style_gan2_disc.svg" /></p>
<p>Discriminator first transforms the image to a feature map of the same resolution and then
runs it through a series of blocks with residual connections.
The resolution is down-sampled by $2 \times$ at each block while doubling the
number of features.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">489</span><span class="k">class</span> <span class="nc">Discriminator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-85'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-85'>#</a>
                </div>
                <ul>
<li><code>log_resolution</code> is the $\log_2$ of image resolution</li>
<li><code>n_features</code> number of features in the convolution layer at the highest resolution (first block)</li>
<li><code>max_features</code> maximum number of features in any generator block</li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">502</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_resolution</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_features</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span> <span class="n">max_features</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-86'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-86'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">508</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-87'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-87'>#</a>
                </div>
                <p>Layer to convert RGB image to a feature map with <code>n_features</code> number of features.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">511</span>        <span class="bp">self</span><span class="o">.</span><span class="n">from_rgb</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<span class="lineno">512</span>            <span class="n">EqualizedConv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_features</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="lineno">513</span>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
<span class="lineno">514</span>        <span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-88'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-88'>#</a>
                </div>
                <p>Calculate the number of features for each block.</p>
<p>Something like <code>[64, 128, 256, 512, 512, 512]</code>.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">519</span>        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">max_features</span><span class="p">,</span> <span class="n">n_features</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">log_resolution</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-89'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-89'>#</a>
                </div>
                <p>Number of <a href="#discriminator_block">discirminator blocks</a></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">521</span>        <span class="n">n_blocks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-90'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-90'>#</a>
                </div>
                <p>Discriminator blocks</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">523</span>        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">DiscriminatorBlock</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">features</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_blocks</span><span class="p">)]</span>
<span class="lineno">524</span>        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">blocks</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-91'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-91'>#</a>
                </div>
                <p><a href="#mini_batch_std_dev">Mini-batch Standard Deviation</a></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">527</span>        <span class="bp">self</span><span class="o">.</span><span class="n">std_dev</span> <span class="o">=</span> <span class="n">MiniBatchStdDev</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-92'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-92'>#</a>
                </div>
                <p>Number of features after adding the standard deviations map</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">529</span>        <span class="n">final_features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-93'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-93'>#</a>
                </div>
                <p>Final $3 \times 3$ convolution layer</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">531</span>        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">EqualizedConv2d</span><span class="p">(</span><span class="n">final_features</span><span class="p">,</span> <span class="n">final_features</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-94'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-94'>#</a>
                </div>
                <p>Final linear layer to get the classification</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">533</span>        <span class="bp">self</span><span class="o">.</span><span class="n">final</span> <span class="o">=</span> <span class="n">EqualizedLinear</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">final_features</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-95'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-95'>#</a>
                </div>
                <ul>
<li><code>x</code> is the input image of shape <code>[batch_size, 3, height, width]</code></li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">535</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-96'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-96'>#</a>
                </div>
                <p>Try to normalize the image (this is totally optional, but sped up the early training a little)</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">541</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mf">0.5</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-97'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-97'>#</a>
                </div>
                <p>Convert from RGB</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">543</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_rgb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-98'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-98'>#</a>
                </div>
                <p>Run through the <a href="#discriminator_block">discriminator blocks</a></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">545</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-99'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-99'>#</a>
                </div>
                <p>Calculate and append <a href="#mini_batch_std_dev">mini-batch standard deviation</a></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">548</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_dev</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-100'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-100'>#</a>
                </div>
                <p>$3 \times 3$ convolution</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">550</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-101'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-101'>#</a>
                </div>
                <p>Flatten</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">552</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-102'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-102'>#</a>
                </div>
                <p>Return the classification score</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">554</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">final</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-103'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-103'>#</a>
                </div>
                <p><a id="discriminator_black"></a></p>
<h3>Discriminator Block</h3>
<p><img alt="Discriminator block" src="discriminator_block.svg" /></p>
<p>Discriminator block consists of two $3 \times 3$ convolutions with a residual connection.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">557</span><span class="k">class</span> <span class="nc">DiscriminatorBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-104'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-104'>#</a>
                </div>
                <ul>
<li><code>in_features</code> is the number of features in the input feature map</li>
<li><code>out_features</code> is the number of features in the output feature map</li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">567</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_features</span><span class="p">,</span> <span class="n">out_features</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-105'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-105'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">572</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-106'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-106'>#</a>
                </div>
                <p>Down-sampling and $1 \times 1$ convolution layer for the residual connection</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">574</span>        <span class="bp">self</span><span class="o">.</span><span class="n">residual</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">DownSample</span><span class="p">(),</span>
<span class="lineno">575</span>                                      <span class="n">EqualizedConv2d</span><span class="p">(</span><span class="n">in_features</span><span class="p">,</span> <span class="n">out_features</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-107'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-107'>#</a>
                </div>
                <p>Two $3 \times 3$ convolutions</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">578</span>        <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<span class="lineno">579</span>            <span class="n">EqualizedConv2d</span><span class="p">(</span><span class="n">in_features</span><span class="p">,</span> <span class="n">in_features</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="lineno">580</span>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
<span class="lineno">581</span>            <span class="n">EqualizedConv2d</span><span class="p">(</span><span class="n">in_features</span><span class="p">,</span> <span class="n">out_features</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="lineno">582</span>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
<span class="lineno">583</span>        <span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-108'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-108'>#</a>
                </div>
                <p>Down-sampling layer</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">586</span>        <span class="bp">self</span><span class="o">.</span><span class="n">down_sample</span> <span class="o">=</span> <span class="n">DownSample</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-109'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-109'>#</a>
                </div>
                <p>Scaling factor $\frac{1}{\sqrt 2}$ after adding the residual</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">589</span>        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-110'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-110'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">591</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-111'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-111'>#</a>
                </div>
                <p>Get the residual connection</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">593</span>        <span class="n">residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-112'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-112'>#</a>
                </div>
                <p>Convolutions</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">596</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-113'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-113'>#</a>
                </div>
                <p>Down-sample</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">598</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_sample</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-114'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-114'>#</a>
                </div>
                <p>Add the residual and scale</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">601</span>        <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">residual</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-115'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-115'>#</a>
                </div>
                <p><a id="mini_batch_std_dev"></a></p>
<h3>Mini-batch Standard Deviation</h3>
<p>Mini-batch standard deviation calculates the standard deviation
across a mini-batch (or a subgroups within the mini-batch)
for each feature in the feature map. Then it takes the mean of all
the standard deviations and appends it to the feature map as one extra feature.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">604</span><span class="k">class</span> <span class="nc">MiniBatchStdDev</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-116'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-116'>#</a>
                </div>
                <ul>
<li><code>group_size</code> is the number of samples to calculate standard deviation across.</li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">616</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-117'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-117'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">620</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="lineno">621</span>        <span class="bp">self</span><span class="o">.</span><span class="n">group_size</span> <span class="o">=</span> <span class="n">group_size</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-118'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-118'>#</a>
                </div>
                <ul>
<li><code>x</code> is the feature map</li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">623</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-119'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-119'>#</a>
                </div>
                <p>Check if the batch size is divisible by the group size</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">628</span>        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_size</span> <span class="o">==</span> <span class="mi">0</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-120'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-120'>#</a>
                </div>
                <p>Split the samples into groups of <code>group_size</code>, we flatten the feature map to a single dimension
since we want to calculate the standard deviation for each feature.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">631</span>        <span class="n">grouped</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-121'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-121'>#</a>
                </div>
                <p>Calculate the standard deviation for each feature among <code>group_size</code> samples
<script type="math/tex; mode=display">\mu_{i} = \frac{1}{N} \sum_g x_{g,i} \\
  \sigma_{i} = \sqrt{\frac{1}{N} \sum_g (x_{g,i} - \mu_i)^2  + \epsilon}</script>
</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">635</span>        <span class="n">std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">grouped</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-122'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-122'>#</a>
                </div>
                <p>Get the mean standard deviation</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">637</span>        <span class="n">std</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-123'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-123'>#</a>
                </div>
                <p>Expand the standard deviation to append to the feature map</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">639</span>        <span class="n">b</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
<span class="lineno">640</span>        <span class="n">std</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-124'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-124'>#</a>
                </div>
                <p>Append (concatenate) the standard deviations to the feature map</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">642</span>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">std</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-125'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-125'>#</a>
                </div>
                <p><a id="down_sample"></a></p>
<h3>Down-sample</h3>
<p>The down-sample operation <a href="#smooth">smoothens</a> each feature channel and
 scale $2 \times$ using bilinear interpolation.
This is based on the paper
 <a href="https://arxiv.org/abs/1904.11486">Making Convolutional Networks Shift-Invariant Again</a>.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">645</span><span class="k">class</span> <span class="nc">DownSample</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-126'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-126'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">656</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">657</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-127'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-127'>#</a>
                </div>
                <p>Smoothing layer</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">659</span>        <span class="bp">self</span><span class="o">.</span><span class="n">smooth</span> <span class="o">=</span> <span class="n">Smooth</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-128'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-128'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">661</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-129'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-129'>#</a>
                </div>
                <p>Smoothing or blurring</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">663</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-130'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-130'>#</a>
                </div>
                <p>Scaled down</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">665</span>        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-131'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-131'>#</a>
                </div>
                <p><a id="up_sample"></a></p>
<h3>Up-sample</h3>
<p>The up-sample operation scales the image up by $2 \times$ and <a href="#smooth">smoothens</a> each feature channel.
This is based on the paper
 <a href="https://arxiv.org/abs/1904.11486">Making Convolutional Networks Shift-Invariant Again</a>.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">668</span><span class="k">class</span> <span class="nc">UpSample</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-132'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-132'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">678</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">679</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-133'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-133'>#</a>
                </div>
                <p>Up-sampling layer</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">681</span>        <span class="bp">self</span><span class="o">.</span><span class="n">up_sample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-134'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-134'>#</a>
                </div>
                <p>Smoothing layer</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">683</span>        <span class="bp">self</span><span class="o">.</span><span class="n">smooth</span> <span class="o">=</span> <span class="n">Smooth</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-135'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-135'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">685</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-136'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-136'>#</a>
                </div>
                <p>Up-sample and smoothen</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">687</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">up_sample</span><span class="p">(</span><span class="n">x</span><span class="p">))</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-137'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-137'>#</a>
                </div>
                <p><a id="smooth"></a></p>
<h3>Smoothing Layer</h3>
<p>This layer blurs each channel</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">690</span><span class="k">class</span> <span class="nc">Smooth</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-138'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-138'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">698</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">699</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-139'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-139'>#</a>
                </div>
                <p>Blurring kernel</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">701</span>        <span class="n">kernel</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
<span class="lineno">702</span>                  <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
<span class="lineno">703</span>                  <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-140'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-140'>#</a>
                </div>
                <p>Convert the kernel to a PyTorch tensor</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">705</span>        <span class="n">kernel</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="n">kernel</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-141'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-141'>#</a>
                </div>
                <p>Normalize the kernel</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">707</span>        <span class="n">kernel</span> <span class="o">/=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-142'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-142'>#</a>
                </div>
                <p>Save kernel as a fixed parameter (no gradient updates)</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">709</span>        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-143'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-143'>#</a>
                </div>
                <p>Padding layer</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">711</span>        <span class="bp">self</span><span class="o">.</span><span class="n">pad</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReplicationPad2d</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-144'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-144'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">713</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-145'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-145'>#</a>
                </div>
                <p>Get shape of the input feature map</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">715</span>        <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-146'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-146'>#</a>
                </div>
                <p>Reshape for smoothening</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">717</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-147'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-147'>#</a>
                </div>
                <p>Add padding</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">720</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-148'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-148'>#</a>
                </div>
                <p>Smoothen (blur) with the kernel</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">723</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-149'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-149'>#</a>
                </div>
                <p>Reshape and return</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">726</span>        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-150'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-150'>#</a>
                </div>
                <p><a id="equalized_linear"></a></p>
<h2>Learning-rate Equalized Linear Layer</h2>
<p>This uses <a href="$equalized_weights">learning-rate equalized weights</a> for a linear layer.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">729</span><span class="k">class</span> <span class="nc">EqualizedLinear</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-151'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-151'>#</a>
                </div>
                <ul>
<li><code>in_features</code> is the number of features in the input feature map</li>
<li><code>out_features</code> is the number of features in the output feature map</li>
<li><code>bias</code> is the bias initialization constant</li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">737</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">out_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">bias</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-152'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-152'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">744</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-153'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-153'>#</a>
                </div>
                <p><a href="$equalized_weights">Learning-rate equalized weights</a></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">746</span>        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">EqualizedWeight</span><span class="p">([</span><span class="n">out_features</span><span class="p">,</span> <span class="n">in_features</span><span class="p">])</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-154'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-154'>#</a>
                </div>
                <p>Bias</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">748</span>        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">out_features</span><span class="p">)</span> <span class="o">*</span> <span class="n">bias</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-155'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-155'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">750</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-156'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-156'>#</a>
                </div>
                <p>Linear transformation</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">752</span>        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">(),</span> <span class="n">bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-157'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-157'>#</a>
                </div>
                <p><a id="equalized_conv2d"></a></p>
<h2>Learning-rate Equalized 2D Convolution Layer</h2>
<p>This uses <a href="$equalized_weights">learning-rate equalized weights</a> for a convolution layer.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">755</span><span class="k">class</span> <span class="nc">EqualizedConv2d</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-158'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-158'>#</a>
                </div>
                <ul>
<li><code>in_features</code> is the number of features in the input feature map</li>
<li><code>out_features</code> is the number of features in the output feature map</li>
<li><code>kernel_size</code> is the size of the convolution kernel</li>
<li><code>padding</code> is the padding to be added on both sides of each size dimension</li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">763</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">out_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="lineno">764</span>                 <span class="n">kernel_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">padding</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-159'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-159'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">771</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-160'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-160'>#</a>
                </div>
                <p>Padding size</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">773</span>        <span class="bp">self</span><span class="o">.</span><span class="n">padding</span> <span class="o">=</span> <span class="n">padding</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-161'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-161'>#</a>
                </div>
                <p><a href="$equalized_weights">Learning-rate equalized weights</a></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">775</span>        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">EqualizedWeight</span><span class="p">([</span><span class="n">out_features</span><span class="p">,</span> <span class="n">in_features</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">])</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-162'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-162'>#</a>
                </div>
                <p>Bias</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">777</span>        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">out_features</span><span class="p">))</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-163'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-163'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">779</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-164'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-164'>#</a>
                </div>
                <p>Convolution</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">781</span>        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">(),</span> <span class="n">bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-165'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-165'>#</a>
                </div>
                <p><a id="equalized_weight"></a></p>
<h2>Learning-rate Equalized Weights Parameter</h2>
<p>This is based on equalized learning rate introduced in the Progressive GAN paper.
Instead of initializing weights at $\mathcal{N}(0,c)$ they initialize weights
to $\mathcal{N}(0, 1)$ and then multiply them by $c$ when using it.
<script type="math/tex; mode=display">w_i = c \hat{w}_i</script>
</p>
<p>The gradients on stored parameters $\hat{w}$ get multiplied by $c$ but this doesn&rsquo;t have
an affect since optimizers such as Adam normalize them by a running mean of the squared gradients.</p>
<p>The optimizer updates on $\hat{w}$ are proportionate to the learning rate $\lambda$.
But the effective weights $w$ get updated proportionately to $c \lambda$.
Without equalized learning rate, the effective weights will get updated proportionately to just $\lambda$.</p>
<p>So we are effectively scaling the learning rate by $c$ for these weight parameters.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">784</span><span class="k">class</span> <span class="nc">EqualizedWeight</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-166'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-166'>#</a>
                </div>
                <ul>
<li><code>shape</code> is the shape of the weight parameter</li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">804</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-167'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-167'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">808</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-168'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-168'>#</a>
                </div>
                <p>He initialization constant</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">811</span>        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-169'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-169'>#</a>
                </div>
                <p>Initialize the weights with $\mathcal{N}(0, 1)$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">813</span>        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-170'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-170'>#</a>
                </div>
                <p>Weight multiplication coefficient</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre></pre></div>
            </div>
        </div>
    <div class='section' id='section-171'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-171'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">816</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-172'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-172'>#</a>
                </div>
                <p>Multiply the weights by $c$ and return</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">818</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-173'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-173'>#</a>
                </div>
                <p><a id="gradient_penalty"></a></p>
<h2>Gradient Penalty</h2>
<p>This is the $R_1$ regularization penality from the paper
<a href="https://arxiv.org/abs/1801.04406">Which Training Methods for GANs do actually Converge?</a>.</p>
<p>
<script type="math/tex; mode=display">R_1(\psi) = \frac{\gamma}{2} \mathbb{E}_{p_\mathcal{D}(x)}
\Big[\Vert \nabla_x D_\psi(x)^2 \Vert\Big]</script>
</p>
<p>That is we try to reduce the L2 norm of gradients of the discriminator with
respect to images, for real images ($P_\mathcal{D}$).</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">821</span><span class="k">class</span> <span class="nc">GradientPenalty</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-174'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-174'>#</a>
                </div>
                <ul>
<li><code>x</code> is $x \sim \mathcal{D}$</li>
<li><code>d</code> is $D(x)$</li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">836</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-175'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-175'>#</a>
                </div>
                <p>Get batch size</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">843</span>        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-176'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-176'>#</a>
                </div>
                <p>Calculate gradients of $D(x)$ with respect to $x$.
<code>grad_outputs</code> is set to $1$ since we want the gradients of $D(x)$,
and we need to create and retain graph since we have to compute gradients
with respect to weight on this loss.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">849</span>        <span class="n">gradients</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">outputs</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
<span class="lineno">850</span>                                            <span class="n">inputs</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
<span class="lineno">851</span>                                            <span class="n">grad_outputs</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">new_ones</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
<span class="lineno">852</span>                                            <span class="n">create_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-177'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-177'>#</a>
                </div>
                <p>Reshape gradients to calculate the norm</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">855</span>        <span class="n">gradients</span> <span class="o">=</span> <span class="n">gradients</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-178'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-178'>#</a>
                </div>
                <p>Calculate the norm $\Vert \nabla_{x} D(x)^2 \Vert$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">857</span>        <span class="n">norm</span> <span class="o">=</span> <span class="n">gradients</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-179'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-179'>#</a>
                </div>
                <p>Return the loss $\Vert \nabla_x D_\psi(x)^2 \Vert$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">859</span>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">norm</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-180'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-180'>#</a>
                </div>
                <p><a id="path_length_penalty"></a></p>
<h2>Path Length Penalty</h2>
<p>This regularization encourages a fixed-size step in $w$ to result in a fixed-magnitude
change in the image.</p>
<p>
<script type="math/tex; mode=display">\mathbb{E}_{w \sim f(z), y \sim \mathcal{N}(0, \mathbf{I})}
  \Big(\Vert \mathbf{J}^\top_{w} y \Vert_2 - a \Big)^2</script>
</p>
<p>where $\mathbf{J}_w$ is the Jacobian
$\mathbf{J}_w = \frac{\partial g}{\partial w}$,
$w$ are sampled from $w \in \mathcal{W}$ from the mapping network, and
$y$ are images with noise $\mathcal{N}(0, \mathbf{I})$.</p>
<p>$a$ is the exponential moving average of $\Vert \mathbf{J}^\top_{w} y \Vert_2$
as the training progresses.</p>
<p>$\mathbf{J}^\top_{w} y$ is calculated without explicitly calculating the Jacobian using
<script type="math/tex; mode=display">\mathbf{J}^\top_{w} y = \nabla_w \big(g(w) \cdot y \big)</script>
</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">862</span><span class="k">class</span> <span class="nc">PathLengthPenalty</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-181'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-181'>#</a>
                </div>
                <ul>
<li><code>beta</code> is the constant $\beta$ used to calculate the exponential moving average $a$</li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">885</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-182'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-182'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">889</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-183'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-183'>#</a>
                </div>
                <p>$\beta$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">892</span>        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-184'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-184'>#</a>
                </div>
                <p>Number of steps calculated $N$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">894</span>        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-185'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-185'>#</a>
                </div>
                <p>Exponential sum of $\mathbf{J}^\top_{w} y$
<script type="math/tex; mode=display">\sum^N_{i=1} \beta^{(N - i)}[\mathbf{J}^\top_{w} y]_i</script>
where $[\mathbf{J}^\top_{w} y]_i$ is the value of it at $i$-th step of training</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">898</span>        <span class="bp">self</span><span class="o">.</span><span class="n">exp_sum_a</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-186'>
        <div class='docs doc-strings'>
                <div class='section-link'>
                    <a href='#section-186'>#</a>
                </div>
                <ul>
<li><code>w</code> is the batch of $w$ of shape <code>[batch_size, d_latent]</code></li>
<li><code>x</code> are the generated images of shape <code>[batch_size, 3, height, width]</code></li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">900</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-187'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-187'>#</a>
                </div>
                <p>Get the device</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">907</span>        <span class="n">device</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-188'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-188'>#</a>
                </div>
                <p>Get number of pixels</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">909</span>        <span class="n">image_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-189'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-189'>#</a>
                </div>
                <p>Calculate $y \in \mathcal{N}(0, \mathbf{I})$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">911</span>        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-190'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-190'>#</a>
                </div>
                <p>Calculate $\big(g(w) \cdot y \big)$ and normalize by the square root of image size.
This is scaling is not mentioned in the paper but was present in
<a href="https://github.com/NVlabs/stylegan2/blob/master/training/loss.py#L167">their implementation</a>.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">915</span>        <span class="n">output</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">image_size</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-191'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-191'>#</a>
                </div>
                <p>Calculate gradients to get $\mathbf{J}^\top_{w} y$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">918</span>        <span class="n">gradients</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">outputs</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
<span class="lineno">919</span>                                            <span class="n">inputs</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
<span class="lineno">920</span>                                            <span class="n">grad_outputs</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span>
<span class="lineno">921</span>                                            <span class="n">create_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-192'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-192'>#</a>
                </div>
                <p>Calculate L2-norm of $\mathbf{J}^\top_{w} y$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">924</span>        <span class="n">norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">gradients</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-193'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-193'>#</a>
                </div>
                <p>Regularize after first step</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">927</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-194'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-194'>#</a>
                </div>
                <p>Calculate $a$
<script type="math/tex; mode=display">\frac{1}{1 - \beta^N} \sum^N_{i=1} \beta^{(N - i)}[\mathbf{J}^\top_{w} y]_i</script>
</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">930</span>            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_sum_a</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-195'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-195'>#</a>
                </div>
                <p>Calculate the penalty
<script type="math/tex; mode=display">\mathbb{E}_{w \sim f(z), y \sim \mathcal{N}(0, \mathbf{I})}
\Big(\Vert \mathbf{J}^\top_{w} y \Vert_2 - a \Big)^2</script>
</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">934</span>            <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">norm</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="lineno">935</span>        <span class="k">else</span><span class="p">:</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-196'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-196'>#</a>
                </div>
                <p>Return a dummy loss if we can&rsquo;t calculate $a$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">937</span>            <span class="n">loss</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-197'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-197'>#</a>
                </div>
                <p>Calculate the mean of $\Vert \mathbf{J}^\top_{w} y \Vert_2$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">940</span>        <span class="n">mean</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-198'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-198'>#</a>
                </div>
                <p>Update exponential sum</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">942</span>        <span class="bp">self</span><span class="o">.</span><span class="n">exp_sum_a</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-199'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-199'>#</a>
                </div>
                <p>Increment $N$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">944</span>        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-200'>
            <div class='docs'>
                <div class='section-link'>
                    <a href='#section-200'>#</a>
                </div>
                <p>Return the penalty</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="lineno">947</span>        <span class="k">return</span> <span class="n">loss</span></pre></div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_HTML">
</script>
<!-- MathJax configuration -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'] ],
            displayMath: [ ['$$','$$'] ],
            processEscapes: true,
            processEnvironments: true
        },
        // Center justify equations in code and markdown cells. Elsewhere
        // we use CSS to left justify single line equations in code cells.
        displayAlign: 'center',
        "HTML-CSS": { fonts: ["TeX"] }
    });
</script>
<script>
    function handleImages() {
        var images = document.querySelectorAll('p>img')

        console.log(images);
        for (var i = 0; i < images.length; ++i) {
            handleImage(images[i])
        }
    }

    function handleImage(img) {
        img.parentElement.style.textAlign = 'center'

        var modal = document.createElement('div')
        modal.id = 'modal'

        var modalContent = document.createElement('div')
        modal.appendChild(modalContent)

        var modalImage = document.createElement('img')
        modalContent.appendChild(modalImage)

        var span = document.createElement('span')
        span.classList.add('close')
        span.textContent = 'x'
        modal.appendChild(span)

        img.onclick = function () {
            console.log('clicked')
            document.body.appendChild(modal)
            modalImage.src = img.src
        }

        span.onclick = function () {
            document.body.removeChild(modal)
        }
    }

    handleImages()
</script>
</body>
</html>